{% extends "layout.html" %}
{% block head %}
{% endblock %}
{% block content %}

<!--Banner component -->
<div class="bg-cover bg-center mt-1  h-auto text-white py-24 px-10 object-fill"
    style="background-image: url(../static/images/family.webp)">
    <div class="md:w-full flex flex-col items-center justify-center md:mt-20">
        <!-- <p class="font-bold text-sm uppercase">Services</p> -->
        <h1 class="text-center   bell-bold font-bold text-2xl lg:text-4xl  text-[#d13642] ">Blog</h1>
        <p class="text-md bell font-bold sm:text-xl md:text-2xl text-center text-red-600">
            Check on our articles where we worked tremendously
        </p>
        <!-- <button href="#" class="bg-purple-800 py-4 px-8 text-white font-bold uppercase text-xs rounded hover:bg-gray-200 hover:text-gray-800"> -->

        <!-- SVG Container -->
        <div class="container mt-4 mx-auto max-w-7xl flex justify-center">
            <svg fill="#000000" width="50px" height="50px" viewBox="0 0 24 24" id="down-arrow-circle"
                data-name="Flat Color" xmlns="http://www.w3.org/2000/svg"
                class="icon-container icon flat-color animate-bounce w-12 h-12" onclick="scrollToSection()">
                <circle id="primary" cx="12" cy="12" r="10" style="fill: rgb(0, 0, 0);"></circle>
                <path id="secondary"
                    d="M14.14,13H13V7a1,1,0,0,0-2,0v6H9.86a1,1,0,0,0-.69,1.5l2.14,3.12a.82.82,0,0,0,1.38,0l2.14-3.12A1,1,0,0,0,14.14,13Z"
                    style="fill: rgb(44, 169, 188);">
                    Contact us
                </path>

            </svg>
        </div>
        <!-- </button> -->


    </div>
</div>

<!-- Blog -->
<section data-aos="fade-up" data-aos-duration="1000" class="z-20 sticky top-0 bg-white h-full">
    <div class=" mb-1 mt-1 md:mb-4 py-8  mx-auto max-w-7xl w-full px-4 sm:px-6 md:px-8 ">
        <!-- <div class="">
            <h2
                class="text-xl font-extrabold w-fit bell-bold text-red-800 sm:text-3xl  mb-4 pb-1 px-2 rounded-md border-b-2 border-red-800 text-center md:text-left">
                Featured
                <span class="text-indigo-900">Articles</span>
            </h2>
        </div> -->
        <div id="featured-articles" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Dynamic content will be injected here -->
        </div>
    </div>
</section>




<script>
    const socket = io();

    // Load articles on connection
    socket.on('initial_data', (data) => {
        displayArticles(data);
    });

    // Listen for updates
    socket.on('update_featured', ({ type, data }) => {
        const updatedSection = { [type]: data };
        displayArticles(updatedSection, true); // Partial update
    });

    function renderMedia(link) {
        // Check if the link is a YouTube video
        const youtubeMatch = link.match(/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([\w-]+)/) ||
            link.match(/(?:https?:\/\/)?youtu\.be\/([\w-]+)/);
        if (youtubeMatch) {
            const videoId = youtubeMatch[1];
            return `<iframe width="360" height="205" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
        }

        // Check if the link is an image (ends with common image extensions)
        const imageMatch = link.match(/\.(jpeg|jpg|gif|png|webp)$/i);
        if (imageMatch) {
            return `<img src="${link}" alt="Article Image" class="w-full max-h-[205px] object-cover">`;
        }

        // Check if the link is a video file (ends with video extensions)
        const videoMatch = link.match(/\.(mp4|mov|avi|mkv|webm)$/i);
        if (videoMatch) {
            return `<video controls class="w-full max-h-80">
                        <source src="${link}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>`;
        }

        // If it's not an image, YouTube video, or video file, just link it
        return `<a href="${link}" target="_blank" class="text-blue-500 underline">${link}</a>`;
    }

    function displayArticles(featuredArticles, isPartialUpdate = false) {
        for (const [type, articles] of Object.entries(featuredArticles)) {
            let sectionElement = document.getElementById(type);

            // If section does not exist and it's not a partial update, create it
            if (!sectionElement && !isPartialUpdate) {
                sectionElement = document.createElement('div');
                sectionElement.id = type;
                sectionElement.innerHTML = `<h2 class="text-xl bell text-red-900 font-bold mb-4">${type.toUpperCase()}</h2>`;
                document.getElementById('featured-articles').appendChild(sectionElement);
            }

            // Clear section content on partial update to avoid duplicate entries
            if (isPartialUpdate) {
                sectionElement.innerHTML = `<h2 class="text-xl font-bold mb-4">${type.toUpperCase()}</h2>`;
            }

            // Render articles
            articles.forEach((article, index) => {
                const articleHTML = `
                    <div class="p-4 bg-white shadow mb-4">
                        <h3 class="text-lg bell-bold font-bold text-red-800">${article.title || 'Untitled'}</h3>
                        <p class="bell-regular text-gray-900 text-md">${article.description || 'No description available.'}</p>
                        <p class="text-sm bell text-blue-700">Featured At: ${article.time_featured}</p>
                        <p class="text-sm bell text-red-700">Time to Read: ${article.time_to_read}</p>
                        ${renderMedia(article.link)}
                        <button class="mt-4 px-4 py-2 bell text-md bg-yellow-500 text-white rounded"
                                onclick="('${type}', ${index}, ${!article.is_featured})">
                            ${article.is_featured ? 'Unfeature' : 'Featured'}
                        </button>
                    </div>
                `;
                sectionElement.innerHTML += articleHTML;
            });
        }
    }

    async function toggleFeatured(type, index, isFeatured) {
        try {
            const response = await fetch(`/realtime/toggle-featured/${type}/${index}`, {
                method: 'POST',
                body: JSON.stringify({ isFeatured }),
                headers: {
                    'Content-Type': 'application/json',
                },
            });

            if (response.ok) {
                alert(isFeatured ? 'Article featured!' : 'Article unfeatured!');
            } else {
                const error = await response.json();
                alert(error.error || 'Failed to update feature status.');
            }
        } catch (error) {
            alert('An error occurred while updating feature status.');
        }
    }



    document.getElementById('article-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);

        const link = formData.get('link');
        const file = formData.get('file');

        // Ensure either link or file is provided, but not both
        if (link && file.size > 0) {
            alert('Please provide either a video link or upload a video file, but not both.');
            return;
        }

        if (!link && file.size === 0) {
            alert('Please provide a video link or upload a video file.');
            return;
        }

        try {
            const articleType = formData.get('article_type');
            const response = await fetch(`/realtime/add-article/${articleType}`, {
                method: 'POST',
                body: formData,
            });

            if (response.ok) {
                form.reset();
                alert('Video added successfully!');
            } else {
                const error = await response.json();
                alert(`Error: ${error.message}`);
            }
        } catch (error) {
            console.error('Error submitting form:', error);
            alert('An error occurred. Please try again.');
        }
    });
</script>

{% endblock %}